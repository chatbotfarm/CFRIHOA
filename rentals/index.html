<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CFRIHOA ‚Äî Available Rentals</title>
  <meta name="description" content="Browse available CFRIHOA rental units in Central Falls, RI." />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --muted:#9fb0c3;
      --text:#e7f0ff;
      --line:#203044;
      --accent:#7ec8ff;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:26px}
    .top{
      display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:18px;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{
      width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(180deg,#18263c,#0d1522);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      font-size:22px;
    }
    h1{margin:0;font-size:24px;letter-spacing:.4px}
    .sub{margin:4px 0 0;color:var(--muted)}

    .card{
      background:linear-gradient(180deg,#121c2b,#0f1725);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
    }
    .controls{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:14px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      color:var(--muted);
      background:rgba(11,15,20,.35);
    }
    .pill b{color:var(--text);font-weight:700}
    .input, select{
      font:inherit;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0c1320;
      color:var(--text);
      min-width: 220px;
      outline:none;
    }
    .btn{
      font:inherit;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#13223a;
      color:var(--text);
      cursor:pointer;
    }
    .btn:hover{border-color:#2a4260}
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 640px){
      .grid{grid-template-columns:1fr;}
      .input, select{min-width: 1px; width:100%;}
    }

    .listing{
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--line);
      background:#0b1220;
      display:flex;
      flex-direction:column;
      min-height: 340px;
      transition: transform .12s ease, border-color .12s ease;
    }
    .listing:hover{transform: translateY(-2px);border-color:#2a4260;}

    .img{
      height:170px;
      background:#0c1320;
      border-bottom:1px solid var(--line);
      position:relative;
      overflow:hidden;
    }
    .img img{width:100%;height:100%;object-fit:cover;display:block;transform: scale(1.02);}
    .badge{
      position:absolute;left:10px;top:10px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,15,20,.55);
      backdrop-filter: blur(6px);
      color:var(--text);
      font-size:12px;
    }
    .body{padding:12px 12px 14px;display:flex;flex-direction:column;gap:8px;flex:1}
    .title{font-weight:800;font-size:15px}
    .meta{color:var(--muted);font-size:12px}
    .price{
      margin-top:auto;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding-top:10px;border-top:1px solid rgba(255,255,255,.06);
    }
    .price b{font-size:16px}
    .cta{color:var(--accent);font-weight:700;}
    .empty{padding:18px;color:var(--muted);text-align:center;}
    .foot{
      margin-top:16px;color:var(--muted);font-size:12px;
      display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;
    }
    .note a{color:var(--accent);text-decoration:underline}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">üè†</div>
        <div>
          <h1>CFRIHOA</h1>
          <div class="sub">Available rental units</div>
        </div>
      </div>

      <div class="pill">
        <span>Status:</span>
        <b id="statusText">Loading‚Ä¶</b>
      </div>
    </div>

    <div class="card">
      <div class="controls">
        <input id="q" class="input" placeholder="Search (title, floor, unit code‚Ä¶)" />
        <select id="sort">
          <option value="updated_desc">Sort: Recently updated</option>
          <option value="price_asc">Sort: Price (low ‚Üí high)</option>
          <option value="price_desc">Sort: Price (high ‚Üí low)</option>
          <option value="beds_desc">Sort: Beds (high ‚Üí low)</option>
        </select>
        <button id="btnRefresh" class="btn" type="button">Refresh</button>

        <span class="pill">
          <span>Results:</span>
          <b id="count">0</b>
        </span>
      </div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">No available listings found.</div>
    </div>

    <div class="foot">
      <div class="note">
        Admin: <a href="https://admin.cfrihoa.com" target="_blank" rel="noopener">admin.cfrihoa.com</a>
      </div>
      <div class="note">
        API: <a href="https://api.cfrihoa.com/api/listings" target="_blank" rel="noopener">/api/listings</a>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // If you set a Cloudflare Pages env var named API_BASE, it will NOT automatically appear in window.
      // So we default to the known URL. If you later inject window.API_BASE manually, it will override.
      var API_BASE = (window.API_BASE && String(window.API_BASE)) || "https://api.cfrihoa.com";

      function $(id){ return document.getElementById(id); }

      var all = [];

      function safeText(v){
        return (v === null || v === undefined) ? "" : String(v);
      }

      function money(v){
        if (v === null || v === undefined || v === "") return "";
        var n = Number(v);
        if (!Number.isFinite(n)) return String(v);
        return n.toLocaleString(undefined, { style:"currency", currency:"USD", maximumFractionDigits:0 });
      }

      function placeholderDataUrl(){
        var svg =
          '<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">' +
          '<defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1">' +
          '<stop offset="0" stop-color="#121c2b"/>' +
          '<stop offset="1" stop-color="#0b1220"/>' +
          '</linearGradient></defs>' +
          '<rect width="100%" height="100%" fill="url(#g)"/>' +
          '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"' +
          ' fill="#9fb0c3" font-family="system-ui,Segoe UI,Roboto" font-size="40">' +
          'No Photo</text></svg>';
        return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
      }

      function imgOrPlaceholder(url){
        return url ? url : placeholderDataUrl();
      }

      function sortListings(list, mode){
        var arr = list.slice();
        switch(mode){
          case "price_asc":
            arr.sort(function(a,b){ return (Number(a.price)||0) - (Number(b.price)||0); }); break;
          case "price_desc":
            arr.sort(function(a,b){ return (Number(b.price)||0) - (Number(a.price)||0); }); break;
          case "beds_desc":
            arr.sort(function(a,b){ return (Number(b.beds)||0) - (Number(a.beds)||0); }); break;
          case "updated_desc":
          default:
            arr.sort(function(a,b){ return safeText(b.updated_at).localeCompare(safeText(a.updated_at)); });
        }
        return arr;
      }

      function filterListings(list, q){
        q = (q||"").trim().toLowerCase();
        if (!q) return list;
        return list.filter(function(l){
          var hay = [
            l.title, l.slug, l.city, l.state, l.floor, l.unit_code,
            l.description, String(l.price||""), String(l.beds||""), String(l.baths||"")
          ].map(safeText).join(" ").toLowerCase();
          return hay.indexOf(q) !== -1;
        });
      }

      function render(){
        var q = $("q").value;
        var sortMode = $("sort").value;

        var filtered = sortListings(filterListings(all, q), sortMode);
        $("count").textContent = String(filtered.length);

        var grid = $("grid");
        grid.innerHTML = "";

        $("empty").style.display = filtered.length ? "none" : "";

        for (var i=0;i<filtered.length;i++){
          var l = filtered[i];
          var href = "/rentals/listing.html?slug=" + encodeURIComponent(l.slug);

          var beds = (l.beds !== null && l.beds !== undefined && l.beds !== "") ? (l.beds + " bd") : "";
          var baths = (l.baths !== null && l.baths !== undefined && l.baths !== "") ? (l.baths + " ba") : "";
          var place = [beds, baths].filter(Boolean).join(" ‚Ä¢ ");

          var photo = imgOrPlaceholder(l.primary_photo_url);

          var metaLine = [
            [safeText(l.city), safeText(l.state)].filter(Boolean).join(", "),
            safeText(l.floor),
            safeText(l.unit_code) ? ("Unit " + safeText(l.unit_code)) : ""
          ].filter(Boolean).join(" ‚Ä¢ ");

          var desc = safeText(l.description);
          var descShort = desc.slice(0, 110) + (desc.length > 110 ? "‚Ä¶" : "");

          var card = document.createElement("a");
          card.className = "listing";
          card.href = href;

          card.innerHTML =
            '<div class="img">' +
              '<img src="' + photo + '" alt="">' +
              '<div class="badge">' + (place || "Available") + '</div>' +
            '</div>' +
            '<div class="body">' +
              '<div class="title">' + (safeText(l.title) || "(Untitled Listing)") + '</div>' +
              '<div class="meta">' + metaLine + '</div>' +
              '<div class="meta">' + descShort + '</div>' +
              '<div class="price">' +
                '<div><b>' + money(l.price) + '</b> <span class="meta">/ month</span></div>' +
                '<div class="cta">View ‚Üí</div>' +
              '</div>' +
            '</div>';

          grid.appendChild(card);
        }
      }

      async function load(){
        $("statusText").textContent = "Loading‚Ä¶";
        try{
          var res = await fetch(API_BASE + "/api/listings", { method:"GET" });
          if (!res.ok) throw new Error(res.status + " " + res.statusText);
          var data = await res.json();

          all = Array.isArray(data.data) ? data.data : [];
          $("statusText").textContent = "Online";
          render();
        }catch(err){
          console.error(err);
          $("statusText").textContent = "Error";
          $("grid").innerHTML = "";
          $("empty").style.display = "";
          $("empty").textContent = "Could not load listings. Check API and CORS.";
        }
      }

      $("q").addEventListener("input", render);
      $("sort").addEventListener("change", render);
      $("btnRefresh").addEventListener("click", load);

      load();
    })();
  </script>
</body>
</html>
