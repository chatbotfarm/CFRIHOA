<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CFRIHOA ‚Äî Rental Listing</title>
  <meta name="description" content="CFRIHOA rental listing details." />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --muted:#9fb0c3;
      --text:#e7f0ff;
      --line:#203044;
      --accent:#7ec8ff;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:26px}

    .top{
      display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:18px;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{
      width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(180deg,#18263c,#0d1522);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      font-size:22px;
    }
    h1{margin:0;font-size:24px;letter-spacing:.4px}
    .sub{margin:4px 0 0;color:var(--muted)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      color:var(--muted);
      background:rgba(11,15,20,.35);
    }
    .pill b{color:var(--text);font-weight:700}

    .card{
      background:linear-gradient(180deg,#121c2b,#0f1725);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .controls{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .btn{
      font:inherit;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#13223a;
      color:var(--text);
      cursor:pointer;
    }
    .btn:hover{border-color:#2a4260}

    .layout{
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){ .layout{grid-template-columns: 1fr;} }

    .panel{
      border:1px solid var(--line);
      border-radius:16px;
      background:#0b1220;
      overflow:hidden;
      min-height: 340px;
    }

    .gallery{
      display:grid;
      grid-template-rows: 360px auto;
      height:100%;
    }
    @media (max-width: 980px){ .gallery{grid-template-rows: 280px auto;} }

    .mainImg{
      width:100%;
      height:100%;
      background:#0c1320;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:block;
      object-fit:cover;
    }

    .thumbs{
      display:flex;
      gap:10px;
      padding:12px;
      overflow:auto;
    }
    .thumb{
      width:110px;
      height:70px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      flex:0 0 auto;
      cursor:pointer;
      opacity:.9;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb.active{border-color:#2a4260;opacity:1}

    .details{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .title{
      font-weight:900;
      font-size:18px;
      line-height:1.2;
    }
    .meta{color:var(--muted);font-size:13px}
    .price{
      margin-top:4px;
      font-size:22px;
      font-weight:900;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:6px;
    }
    .kv{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:10px;
      background:rgba(11,15,20,.25);
    }
    .kv .k{color:var(--muted);font-size:11px;letter-spacing:.08em;text-transform:uppercase}
    .kv .v{margin-top:4px;font-weight:700}

    .desc{
      margin-top:6px;
      color:var(--text);
      opacity:.92;
      white-space:pre-wrap;
    }

    .empty{
      padding:18px;
      color:var(--muted);
      text-align:center;
    }

    .foot{
      margin-top:16px;color:var(--muted);font-size:12px;
      display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;
    }
    .note a{color:var(--accent);text-decoration:underline}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">üè†</div>
        <div>
          <h1>CFRIHOA</h1>
          <div class="sub">Rental listing details</div>
        </div>
      </div>

      <div class="pill">
        <span>Status:</span>
        <b id="statusText">Loading‚Ä¶</b>
      </div>
    </div>

    <div class="card">
      <div class="controls">
        <a class="btn" href="/rentals/">‚Üê Back to Rentals</a>
        <button id="btnRefresh" class="btn" type="button">Refresh</button>

        <span class="pill" style="margin-left:auto;">
          <span>Slug:</span>
          <b id="slugText">‚Äî</b>
        </span>
      </div>

      <div id="content" class="empty">Loading‚Ä¶</div>
    </div>

    <div class="foot">
      <div class="note">
        Admin: <a href="https://admin.cfrihoa.com" target="_blank" rel="noopener">admin.cfrihoa.com</a>
      </div>
      <div class="note">
        API: <a href="https://api.cfrihoa.com/api/listings" target="_blank" rel="noopener">/api/listings</a>
      </div>
    </div>
  </div>

  <script>
    (function(){
      var API_BASE = (window.API_BASE && String(window.API_BASE)) || "https://api.cfrihoa.com";
      function $(id){ return document.getElementById(id); }

      function safeText(v){ return (v === null || v === undefined) ? "" : String(v); }

      function money(v){
        if (v === null || v === undefined || v === "") return "";
        var n = Number(v);
        if (!Number.isFinite(n)) return String(v);
        return n.toLocaleString(undefined, { style:"currency", currency:"USD", maximumFractionDigits:0 });
      }

      function placeholderDataUrl(){
        var svg =
          '<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">' +
          '<defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1">' +
          '<stop offset="0" stop-color="#121c2b"/>' +
          '<stop offset="1" stop-color="#0b1220"/>' +
          '</linearGradient></defs>' +
          '<rect width="100%" height="100%" fill="url(#g)"/>' +
          '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"' +
          ' fill="#9fb0c3" font-family="system-ui,Segoe UI,Roboto" font-size="40">' +
          'No Photo</text></svg>';
        return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
      }

      function getSlug(){
        var params = new URLSearchParams(location.search);
        return (params.get("slug") || "").trim();
      }

      function normalizePhotos(listing){
        var out = [];

        // photos[] may contain photo_url (preferred) or path
        if (listing && Array.isArray(listing.photos)){
          for (var i=0;i<listing.photos.length;i++){
            var p = listing.photos[i] || {};
            var u = p.photo_url || p.url || p.href || "";
            if (!u && p.path){
              u = API_BASE + "/img?path=" + encodeURIComponent(String(p.path));
            }
            if (u) out.push(String(u));
          }
        }

        // primary fallback
        if (out.length === 0 && listing && listing.primary_photo_url){
          out.push(String(listing.primary_photo_url));
        }

        if (out.length === 0) out.push(placeholderDataUrl());
        return out;
      }

      function render(listing){
        var photos = normalizePhotos(listing);

        var title = safeText(listing.title) || "(Untitled Listing)";
        var cityState = [safeText(listing.city), safeText(listing.state)].filter(Boolean).join(", ");
        var meta = [
          cityState,
          safeText(listing.floor),
          safeText(listing.unit_code) ? ("Unit " + safeText(listing.unit_code)) : ""
        ].filter(Boolean).join(" ‚Ä¢ ");

        var beds = safeText(listing.beds);
        var baths = safeText(listing.baths);
        var laundry = safeText(listing.laundry);
        var parking = safeText(listing.parking);
        var desc = safeText(listing.description);

        $("content").className = "";
        $("content").innerHTML =
          '<div class="layout">' +
            '<div class="panel">' +
              '<div class="gallery">' +
                '<img id="mainImg" class="mainImg" src="' + photos[0] + '" alt="">' +
                '<div id="thumbs" class="thumbs"></div>' +
              '</div>' +
            '</div>' +

            '<div class="panel">' +
              '<div class="details">' +
                '<div class="title">' + title + '</div>' +
                '<div class="meta">' + meta + '</div>' +
                '<div class="price">' + money(listing.price) + ' <span class="meta">/ month</span></div>' +

                '<div class="grid2">' +
                  '<div class="kv"><div class="k">Beds</div><div class="v">' + (beds || "‚Äî") + '</div></div>' +
                  '<div class="kv"><div class="k">Baths</div><div class="v">' + (baths || "‚Äî") + '</div></div>' +
                  '<div class="kv"><div class="k">Laundry</div><div class="v">' + (laundry || "‚Äî") + '</div></div>' +
                  '<div class="kv"><div class="k">Parking</div><div class="v">' + (parking || "‚Äî") + '</div></div>' +
                '</div>' +

                '<div class="desc">' + (desc || "") + '</div>' +
              '</div>' +
            '</div>' +
          '</div>';

        // thumbs
        var thumbs = $("thumbs");
        thumbs.innerHTML = "";
        for (var i=0;i<photos.length;i++){
          (function(idx){
            var d = document.createElement("div");
            d.className = "thumb" + (idx === 0 ? " active" : "");
            d.innerHTML = '<img src="' + photos[idx] + '" alt="">';
            d.addEventListener("click", function(){
              $("mainImg").src = photos[idx];
              var kids = thumbs.children;
              for (var k=0;k<kids.length;k++) kids[k].classList.remove("active");
              d.classList.add("active");
            });
            thumbs.appendChild(d);
          })(i);
        }
      }

      async function load(){
        var slug = getSlug();
        $("slugText").textContent = slug || "‚Äî";

        if (!slug){
          $("statusText").textContent = "Error";
          $("content").className = "empty";
          $("content").textContent = "Missing ?slug= in the URL.";
          return;
        }

        $("statusText").textContent = "Loading‚Ä¶";
        $("content").className = "empty";
        $("content").textContent = "Loading‚Ä¶";

        try{
          // API returns list at /api/listings, so we find the listing client-side
          var res = await fetch(API_BASE + "/api/listings", { method:"GET" });
          if (!res.ok) throw new Error(res.status + " " + res.statusText);
          var json = await res.json();
          var list = (json && Array.isArray(json.data)) ? json.data : [];

          var match = null;
          for (var i=0;i<list.length;i++){
            if (String(list[i].slug || "").trim() === slug) { match = list[i]; break; }
          }

          if (!match){
            $("statusText").textContent = "Not found";
            $("content").className = "empty";
            $("content").textContent = "Listing not found for slug: " + slug;
            return;
          }

          $("statusText").textContent = "Online";
          render(match);
        }catch(err){
          console.error(err);
          $("statusText").textContent = "Error";
          $("content").className = "empty";
          $("content").textContent = "Could not load listing. Check API and CORS.";
        }
      }

      $("btnRefresh").addEventListener("click", load);
      load();
    })();
  </script>
</body>
</html>
