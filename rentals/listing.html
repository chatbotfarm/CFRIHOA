<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing — CFRIHOA</title>
  <meta name="description" content="Rental listing details." />
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --muted:#9fb0c3;
      --text:#e7f0ff;
      --line:#203044;
      --accent:#7ec8ff;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:26px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    .back{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:12px;
      background:#0c1320;
      color:var(--text);
      box-shadow: var(--shadow);
    }
    .back:hover{border-color:#2a4260}
    .card{
      background:linear-gradient(180deg,#121c2b,#0f1725);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 920px){ .hero{grid-template-columns:1fr;} }
    .gallery{
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
      background:#0b1220;
      min-height: 360px;
      position:relative;
    }
    .gallery img{
      width:100%;height:100%;object-fit:cover;display:block;
    }
    .thumbs{
      display:flex;gap:8px;flex-wrap:wrap;
      margin-top:10px;
    }
    .thumb{
      width:86px;height:56px;
      border-radius:12px;
      border:1px solid var(--line);
      overflow:hidden;
      cursor:pointer;
      background:#0c1320;
      opacity:.85;
    }
    .thumb.active{outline:2px solid rgba(126,200,255,.6); opacity:1}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .k{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .panel{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:rgba(11,15,20,.35);
    }
    .facts{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 520px){ .facts{grid-template-columns:1fr;} }
    .fact{
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
      padding:10px 12px;
      background:#0b1220;
    }
    .fact .label{font-size:12px;color:var(--muted)}
    .fact .value{font-weight:800;margin-top:4px}
    .price{
      font-size:22px;
      font-weight:900;
      margin-top:8px;
    }
    .hr{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:8px;
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:12px;
      background:#13223a;
      color:var(--text);
      cursor:pointer;
      width:100%;
      font:inherit;
    }
    .btn:hover{border-color:#2a4260}
    .empty{
      padding:18px;
      color:var(--muted);
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="back" href="/rentals">← Back to listings</a>
      <div class="muted">CFRIHOA</div>
    </div>

    <div class="card">
      <div id="content" class="hero">
        <div class="empty">Loading…</div>
      </div>
    </div>
  </div>

<script>
  const API_BASE =
    (window.API_BASE && String(window.API_BASE)) ||
    "https://api.cfrihoa.com";

  function money(v){
    if (v === null || v === undefined || v === "") return "";
    const n = Number(v);
    if (!Number.isFinite(n)) return String(v);
    return n.toLocaleString(undefined, { style:"currency", currency:"USD", maximumFractionDigits:0 });
  }

  function getSlug(){
    const url = new URL(location.href);
    return url.searchParams.get("slug");
  }

  function placeholder(){
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="#121c2b"/>
            <stop offset="1" stop-color="#0b1220"/>
          </linearGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#g)"/>
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
              fill="#9fb0c3" font-family="system-ui,Segoe UI,Roboto" font-size="40">
          No Photo
        </text>
      </svg>
    `);
  }

  function safe(v){ return (v===null||v===undefined) ? "" : String(v); }

  function render(listing){
    document.title = (listing.title ? listing.title + " — " : "") + "CFRIHOA";

    const photos = Array.isArray(listing.photos) ? listing.photos : [];
    const mainUrl = (photos[0] && photos[0].photo_url) || listing.primary_photo_url || placeholder();

    const content = document.getElementById("content");
    content.innerHTML = `
      <div>
        <div class="gallery">
          <img id="mainImg" src="${mainUrl}" alt="">
        </div>
        <div class="thumbs" id="thumbs"></div>
      </div>

      <div class="panel">
        <h1>${safe(listing.title) || "(Untitled Listing)"}</h1>
        <div class="muted">${[safe(listing.city), safe(listing.state)].filter(Boolean).join(", ")}${safe(listing.floor) ? " • " + safe(listing.floor) : ""}</div>

        <div class="price">${money(listing.price)} <span class="muted" style="font-size:13px;font-weight:600">/ month</span></div>

        <div class="facts">
          <div class="fact"><div class="label">Beds</div><div class="value">${safe(listing.beds) || "—"}</div></div>
          <div class="fact"><div class="label">Baths</div><div class="value">${safe(listing.baths) || "—"}</div></div>
          <div class="fact"><div class="label">Laundry</div><div class="value">${safe(listing.laundry) || "—"}</div></div>
          <div class="fact"><div class="label">Parking</div><div class="value">${safe(listing.parking) || "—"}</div></div>
          <div class="fact"><div class="label">Unit Code</div><div class="value k">${safe(listing.unit_code) || "—"}</div></div>
          <div class="fact"><div class="label">Slug</div><div class="value k">${safe(listing.slug) || "—"}</div></div>
        </div>

        <div class="hr"></div>

        <div class="muted" style="white-space:pre-wrap">${safe(listing.description) || "No description provided."}</div>

        <div class="hr"></div>

        <button class="btn" id="btnCopy">Copy share link</button>
      </div>
    `;

    // thumbs
    const thumbs = document.getElementById("thumbs");
    if (!photos.length){
      thumbs.innerHTML = `<div class="muted" style="margin-top:10px">No photos uploaded yet.</div>`;
    } else {
      photos.forEach((p, idx) => {
        const div = document.createElement("div");
        div.className = "thumb" + (idx===0 ? " active" : "");
        div.innerHTML = `<img src="${p.photo_url || placeholder()}" alt="">`;
        div.addEventListener("click", () => {
          document.getElementById("mainImg").src = p.photo_url || placeholder();
          [...thumbs.querySelectorAll(".thumb")].forEach(x=>x.classList.remove("active"));
          div.classList.add("active");
        });
        thumbs.appendChild(div);
      });
    }

    // copy link
    document.getElementById("btnCopy").addEventListener("click", async () => {
      const link = location.href;
      try{
        await navigator.clipboard.writeText(link);
        document.getElementById("btnCopy").textContent = "Copied ✓";
        setTimeout(()=> document.getElementById("btnCopy").textContent = "Copy share link", 1400);
      }catch{
        alert("Copy failed. Link:\n" + link);
      }
    });
  }

  async function load(){
    const slug = getSlug();
    const content = document.getElementById("content");

    if (!slug){
      content.innerHTML = `<div class="empty">Missing <span class="k">?slug=</span></div>`;
      return;
    }

    try{
      const res = await fetch(API_BASE + "/api/listings/" + encodeURIComponent(slug), { method:"GET" });
      if (!res.ok) {
        content.innerHTML = `<div class="empty">Listing not found (or unavailable).</div>`;
        return;
      }
      const data = await res.json();
      if (!data || !data.data){
        content.innerHTML = `<div class="empty">Invalid response from API.</div>`;
        return;
      }
      render(data.data);
    }catch(err){
      console.error(err);
      content.innerHTML = `<div class="empty">Could not load listing. Check API and CORS.</div>`;
    }
  }

  load();
</script>
</body>
</html>
